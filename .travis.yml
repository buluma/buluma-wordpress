sudo: required
dist: trusty
group: edge
language: node_js
os:
- linux
node_js:
- '6'
env:
  global: 
before_install:
- npm install -g npm
- npm --version
install:
- npm install
after_success:
- mkdir -p releases
- PACKAGE_NAME=`scripts/package-name.sh package.json`
- PACKAGE_VERSION=`scripts/package-version.sh package.json`
- RELEASE=${PACKAGE_NAME}-${PACKAGE_VERSION}
- echo ${TRAVIS_NODE_VERSION}-${TRAVIS_TAG}
- COMMIT_LOG=`git log -1 --format='%ci %H %s'`
- COMMIT_HASH=`git log -1 --format="%h"`
- |
  if [[ "$TRAVIS_NODE_VERSION" == "6" && "$TRAVIS_OS_NAME" == "linux" ]]; then
    pushd releases;
    ln -sf ../src ${RELEASE};
    zip -r ${RELEASE}.zip ${RELEASE};
    popd;
    ls -al releases/*;
    if [[ -z "$TRAVIS_TAG" ]]; then
      mv "releases/${RELEASE}.zip" "releases/${RELEASE}-${COMMIT_HASH}.zip";
      npm run github-release -- delete \
        --owner=buluma \
        --repo=buluma-wordpress \
        --tag="latest" \
        --name="${TRAVIS_BRANCH}" \
        "*.zip";
      npm run github-release -- upload \
        --owner=buluma \
        --repo=buluma-wordpress \
        --tag="latest" \
        --name="${TRAVIS_BRANCH}" \
        --body="${COMMIT_LOG}" \
        "releases/${RELEASE}-${COMMIT_HASH}.zip";
    fi
  fi
before_deploy:
# - echo "Deploying to GitHub releases"
# - ls -al releases
- git config --local user.name "buluma"
- git config --local user.email "bulumaknight@gmail.com"
- git tag "$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)"
deploy:
  provider: releases
  api_key:
    secure: eilv9M0KHlJz7v4qYUe3GEo4f3D7PBKMBXtUn7CqyLBkpE08qQWxRS4A25oRuXmT982UGxleW8Et0DUP2ApbZhr0vpPWIH7AaNEDLGd5eHE63C5/LoslVUs6jqYgzGCYy1a30F/0XIuyJR33AqO0MNfYWgMuPG8XM0dLzR5LHbcA/qIOteXvs4uuV81XHNKAnnXJQn9Heheo4tiaZyz8rCPb/YKk3uuuvXMjxXJsUMQYKqCkibuXT9PSHwVZn6EJjk4JcP7aCo3qPbdcGrb8rzcL4CNJtiAtbblPSc4ql0MNMb961KnF5VbchUfq3npDhGrc82Ht0DCvgrBbDoQCoA4y4q6ftzFAF69aCTOwVoMy171ugzoYvIDKLFxQS77/adL7HI7pkrMVXkenE2ba8h9IMVIH/IL/0ukwDPadEDBcyhjhz22ex/ensx0jf3l/aCGk9Ua+tqyTEYdXgH4U+b0d92sQxlWmVjyDIexBt3muAr6sWX5EtjWxnWC/BkZIyblRkFi5s6a5FraifUGanKRLau2gxPiqT9+TsGd01em5LW4q7beg3sVoEcjx10Oq1lmTIgNGVoO1xpYefg3RuTms066j0a5CXOMV88vjv5ZTFXRnuNeCOx24iO/QwTeZD8Ik2BkLJuqRe1WSpWh3batPZFU0szKI+ZKfYoK50kU=
  file: releases/*.*
  on:
    repo: buluma/buluma-wordpress
